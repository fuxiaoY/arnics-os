# 报文格式说明文件

中文 | [English Documentation](ufLogFormatProtocol.en.md)
## 1. 报文格式总览

### 1.1 完整格式

```
[pri] [facility] timestamp version> [kinds] msg (function|file|line) .
```

### 1.2 组成部分说明

| 组成部分                   | 位置          | 分隔符  | 状态  | 说明                       |
| ---------------------- | ----------- | ---- | --- | ------------------------ |
| pri                    | 开头          | 空格   | 必填  | 优先级字段，使用方括号包裹            |
| facility               | pri之后       | 空格   | 可选  | 分类字段，使用方括号包裹，省略时用"-"表示   |
| timestamp              | facility之后  | 空格   | 可选  | 时间戳字段，省略时用"-"表示          |
| version>               | timestamp之后 | 固定符号 | 必填  | 版本号字段，格式为"数字>"，当前固定为"1>" |
| kinds                  | version>之后  | 空格   | 可选  | 模块类型字段，使用方括号包裹，省略时用"-"表示 |
| msg                    | kinds之后     | 空格   | 必填  | 消息内容字段                   |
| (function\|file\|line) | msg之后       | 空格   | 可选  | 灵活选择项，使用圆括号包裹，省略时可忽略整个部分 |
| .                      | 结尾          | 固定符号 | 必填  | 报文结束符                    |

## 2. 字段详细定义

### 2.1 pri（优先级） 

| 枚举值 | 含义   | 使用场景               |
| --- | ---- | ------------------ |
| DBG | 调试信息 | 开发阶段输出的调试内容，用于问题定位 |
| INF | 一般信息 | 正常运行时的状态信息，不影响系统功能 |
| WAR | 警告信息 | 可能存在潜在问题，但不影响当前操作  |
| ERR | 错误信息 | 发生错误但系统仍可运行，功能可能受限 |
| ALT | 严重错误 | 严重错误/异常，可能导致子系统不可用或需立即处理 |
| NOT | 通知   | 重要通知类消息（非错误），用于告知状态变化或事件 |
| ALW | 始终输出 | 无论日志级别如何都应输出的信息（例如关键审计或安全日志） |


### 2.2 facility（分类）

| 分类名称 | 定义   | 适用范围       |
| ---- | ---- | ---------- |
| driv | 驱动   | 设备驱动相关消息   |
| devc | 设备   | 硬件设备相关消息   |
| kern | 内核   | 系统内核相关消息   |
| mail | 邮件   | 邮件服务相关消息   |
| auth | 认证   | 身份认证相关消息   |
| temp | 临时   | 临时调试或测试消息  |
| evet | 事件中心   | 事件中心业务   |
| mdia | 媒体中心   | 媒体中心业务  |
| busi | 决策层   | 决策层业务   |
| admi | 管理策略   | 管理部门相关业务   |
| guad | 督查中心   | 督查/守护进程   |
| csle | 控制台   | 控制台业务   |
| dplt | 数据平台   | 数据相关  |

### 2.3 timestamp（时间戳）

**完整日期时间**
   
   - 格式：YYYY-MM-DD HH:MM:SS
   - 示例：`2000-01-01 03:59:44`


### 2.4 version（版本号）

- 固定值：1
- 格式：`1>`（数字后紧跟">"符号）
- 说明：用于报文格式的版本控制，当前恒为1，未来格式变更时可递增
- 示例：`1>`
- version>字段后允许换行，换行符视为字段分隔符的一部分，不影响报文解析。但强烈建议保持msg各格式字段在同行以提高完整性

### 2.5 kinds（模块类型/业务类型）

共23个模块类型，具体示例指代如下：

| 模块名称 | 说明         | 模块名称 | 说明        |
| ---- | ---------- | ---- | --------- |
| wwdg | 窗口看门狗      | iwdg | 独立看门狗     |
| tim  | 定时器          | uart | 串口相关 |
| can  | 协议总线        | iic  | 协议总线    |
| spi  | 串行外设接口     | pwm  | 脉冲宽度调制    |
| gpio | 通用输入输出     | sdio | sd输入输出  |
| adc  | 模数转换器       | dac  | 数模转换器     |
| dma  | 直接内存访问     | rng  | 随机数生成器    |
| crc  | 循环冗余校验     | rtc  | 实时时钟      |
| fpu  | 浮点运算单元     | hash | 哈希算法      |
| dcmi | 数字摄像头接口   | lcd  | 液晶模块     |
| fsmc | 灵活存储内存接口 | app  | 应用程序      |


业务类型可根据业务场景进行定义，如：
| 模块名称 | 说明         |
| ---- | ---------- |
| blink | LED灯闪烁策略 |
| colorful | LED灯炫丽模式 |
| temp| 临时使用 |
### 2.6 msg（消息内容）

支持四种格式：

#### 2.6.1 struct data格式

- 语法：`[name var="xxx" var2=123 var3=[01 02 03 04] var4={a_teset:123,b_test:"123"}]`
- 说明：使用方括号包裹，支持键值对，值可以是字符串、数字、数组或字典
- 适用场景：结构化数据传递

#### 2.6.2 hex格式

- 语法：`|>0x85 0x96 0x69<|`
- 说明：使用|>和<|作为分隔符，十六进制数字之间用空格分隔
- 适用场景：二进制数据展示

#### 2.6.3 json格式

- 语法：`{a_teset:123,b_test:"123"}`
- 说明：标准JSON格式
- 适用场景：复杂数据结构传递

#### 2.6.4 string格式

- 语法：`hello world! i want to print 23`
- 说明：纯文本字符串，无特殊格式
- 适用场景：简单消息描述

### 2.7 (function\|file\|line)灵活选择项

- 格式：`(function_name|file_path|line)`
- 说明：三个参数用竖线分隔，分别表示函数名、文件路径和打印行数
- 示例：`(business_init|business_process.cpp|58)`
- 各部分说明：
  - function：函数名称，如示例中的"business_init"
  - file：文件路径，如示例中的"business_process.cpp"
  - line：打印行数，如示例中的"58"（表示该打印语句在文件中的行号）

## 3. 格式约束与规则

### 3.1 字段省略规则

- 可选字段（facility、timestamp、kinds、灵活选择项）可省略，省略时使用"-"表示
- 必选字段（pri、version>、msg、.）不可省略
- version字段当前固定为1，不可省略
- 示例：
  - 省略facility和timestamp：`[DBG] - - 1> [adc] message .`
  - 仅保留必填字段：`[DBG] - - 1> message .`

### 3.2 特殊字符处理

- 方括号`[]`：字段标识符，必须保留
- 尖括号`<|`和`|>`：hex格式的分隔符，必须保留
- 逗号`,`：用于分隔数组元素
- 空格：作为字段分隔符，消息内容中的空格可直接使用
- 引号`"`：字符串值的界定符，如`var="xxx"`
- 版本号后的">"：固定分隔符，必须紧跟版本号数字

### 3.3 数据类型规范

- 数组表示：使用方括号`[]`，元素之间用空格分隔，如`[01 02 03 04]`
- 字典表示：使用花括号`{}`,键值对之间用逗号分隔，如`{a_teset:123,b_test:"123"}`
- 十六进制：前缀`0x`，如`0x85`
- 字符串：可加双引号也可不加，建议包含空格时使用双引号

## 4. 完整示例解析

### 4.1 示例一：完整格式报文

```
[DBG] [temp] 00-01-01 03:59:44 1> [adc] this is a print,the local var is:32,{a_teset:123,b_test:"123"},hex is 
|> 51 68 07 65 16 08 <|
 (business_init|business_process.cpp|58) .
```

- **字段解析**：
  - pri: DBG（调试信息）
  - facility: temp（临时分类）
  - timestamp: 00-01-01 03:59:44（月日时间格式）
  - version: 1（版本号）
  - kinds: adc（模数转换器模块）
  - msg: 混合文本、hex格式和struct data格式
  - 灵活选择项: business_init（函数名）、business_process.cpp（文件路径）、58（打印行数）

### 4.2 示例二：省略部分字段

```
[DBG] [temp] - 1> this is a print,the local var is:32 .
```

- **字段解析**：
  - pri: DBG（调试信息）
  - facility: temp（临时分类）
  - timestamp: -（省略）
  - version: 1（版本号）
  - kinds: -（省略）
  - msg: this is a print,the local var is:32（字符串格式）
  - 灵活选择项: 省略

### 4.3 示例三：最小化格式

```
[DBG] - - 1> this is a print,the local var is:32 .
```

- **字段解析**：
  - pri: DBG（调试信息）
  - facility: -（省略）
  - timestamp: -（省略）
  - version: 1（版本号）
  - kinds: -（省略）
  - msg: this is a print,the local var is:32（字符串格式）

### 4.4 补充示例：不同组合场景

#### 4.4.1 使用INF优先级和json格式消息

```
[INF] [driv] 2023-10-01 12:00:00 1> [uart] {"status":"success","data":123} (init_uart|serial.cpp|36) .
```

- 版本字段解析：1（版本号）

#### 4.4.2 使用ERR优先级和hex格式消息

```
[ERR] [kern] - 15:30:45 1> [can] |>0xFF 0x00 0xEE<| (can_send|can_driver.c|128) .
```

- 版本字段解析：1（版本号）

## 5. 最佳实践建议

### 5.1 不同场景下的格式选择指南

- **开发调试**：使用DBG优先级，完整timestamp，包含function和file信息
- **系统监控**：使用INF/WAR优先级，适当简化格式
- **错误报告**：使用ERR优先级，包含完整上下文信息
- **性能敏感场景**：可省略timestamp和灵活选择项，减少开销
  
  

### 5.2 扩展性考虑

- **版本控制**：当前版本固定为1，未来格式变更时建议递增版本号（如2>、3>等）
- **新增facility**：建议使用3-4个字母的缩写，保持与现有分类风格一致
- **新增kinds**：遵循硬件模块或功能模块的英文缩写命名规则
- **新增msg格式**：建议使用新的独特分隔符，避免与现有格式冲突